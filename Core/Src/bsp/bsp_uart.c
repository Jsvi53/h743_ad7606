/*
*********************************************************************************************************
*	                                  
*	模块名称 : 串口打印辅助模块
*	文件名称 : bsp_uart.c
*	版    本 : V1.0
*	说    明 : 串口打印辅助函数实现，包含printf重定向
*
*********************************************************************************************************
*/

#include "bsp/bsp_uart.h"
#include "usart.h"
#include <stdio.h>
#include <stdarg.h>
#include <string.h>

/* 外部UART句柄 */
extern UART_HandleTypeDef huart1;

/*
*********************************************************************************************************
*	函 数 名: BSP_UART_Printf
*	功能说明: 格式化打印到串口1
*	形    参：format - 格式化字符串
*	返 回 值: 无
*********************************************************************************************************
*/
void BSP_UART_Printf(const char *format, ...)
{
    char buffer[256];
    va_list args;
    int len;
    
    va_start(args, format);
    len = vsnprintf(buffer, sizeof(buffer), format, args);
    va_end(args);
    
    if (len > 0 && len < sizeof(buffer)) {
        HAL_UART_Transmit(&huart1, (uint8_t*)buffer, len, HAL_MAX_DELAY);
    }
}

/*
*********************************************************************************************************
*	函 数 名: BSP_UART_SendString
*	功能说明: 发送字符串到串口1
*	形    参：str - 字符串指针
*	返 回 值: 无
*********************************************************************************************************
*/
void BSP_UART_SendString(const char *str)
{
    while (*str) {
        HAL_UART_Transmit(&huart1, (uint8_t*)str, 1, HAL_MAX_DELAY);
        str++;
    }
}

/*
*********************************************************************************************************
*	函 数 名: BSP_UART_SendData
*	功能说明: 发送数据到串口1
*	形    参：data - 数据指针, len - 数据长度
*	返 回 值: 无
*********************************************************************************************************
*/
void BSP_UART_SendData(uint8_t *data, uint16_t len)
{
    HAL_UART_Transmit(&huart1, data, len, HAL_MAX_DELAY);
}

/*
*********************************************************************************************************
*	函 数 名: __io_putchar
*	功能说明: 重定向printf到USART1（实现弱符号）
*	形    参：ch - 要发送的字符
*	返 回 值: 发送的字符
*	说    明: 此函数用于重定向标准C库的printf输出到串口1
*********************************************************************************************************
*/
int __io_putchar(int ch)
{
    HAL_UART_Transmit(&huart1, (uint8_t *)&ch, 1, HAL_MAX_DELAY);
    return ch;
}

/*
*********************************************************************************************************
*	函 数 名: __io_getchar
*	功能说明: 从USART1读取字符（实现弱符号）
*	形    参：无
*	返 回 值: 读取的字符
*	说    明: 此函数用于重定向标准C库的scanf输入从串口1
*********************************************************************************************************
*/
int __io_getchar(void)
{
    uint8_t ch = 0;
    HAL_UART_Receive(&huart1, &ch, 1, HAL_MAX_DELAY);
    return ch;
}

