# AD7606 驱动使用说明

## 一、文件结构

已创建以下文件：

```
Core/Inc/bsp/
    ├── bsp_ad7606.h      # AD7606驱动头文件
    └── bsp_uart.h        # 串口打印辅助函数头文件

Core/Src/bsp/
    ├── bsp_ad7606.c      # AD7606驱动实现
    └── bsp_uart.c        # 串口打印辅助函数实现
```

## 二、GPIO引脚定义

### 当前配置（需要根据实际硬件连接修改）

| AD7606信号 | STM32H743引脚 | 说明 |
|-----------|--------------|------|
| **CS** | **PA4** | 片选信号（已在CubeMX中配置） |
| **CONVST** | **PG13** | 转换启动信号 |
| **RESET** | **PG14** | 复位信号 |
| **RANGE** | **PC4** | 量程选择（需要从输入改为输出） |
| **OS0-OS2** | 未连接 | 过采样选择（可选） |
| **DOUTA (DB7)** | **PA6 (SPI1_MISO)** | SPI数据线（已在CubeMX中配置） |
| **RD/SCLK** | **PA5 (SPI1_SCK)** | SPI时钟（已在CubeMX中配置） |

### ⚠️ 重要提示

**如果您的硬件连接与上述定义不同，请修改 `Core/Inc/bsp/bsp_ad7606.h` 中的GPIO定义！**

## 三、硬件连接检查清单

### AD7606模块配置

- [ ] **PAR/SER/BYTE SEL**: 接**高电平**（VDRIVE）- 选择串行接口模式
- [ ] **DB15**: 接**低电平**（GND）- 选择串行接口模式
- [ ] **VDRIVE**: 连接到3.3V或5V（与MCU逻辑电平匹配）
- [ ] **AVCC**: 连接到5V电源
- [ ] **V1通道**: 连接到1kHz、1V幅值的正弦波信号源

### STM32H743连接

- [ ] **SPI1_SCK (PA5)** → AD7606 **RD/SCLK**
- [ ] **SPI1_MISO (PA6)** → AD7606 **DB7/DOUTA**
- [ ] **PA4 (CS)** → AD7606 **CS**
- [ ] **PG13 (CONVST)** → AD7606 **CONVST A** 和 **CONVST B**（可以并联）
- [ ] **PG14 (RESET)** → AD7606 **RESET**
- [ ] **PC4 (RANGE)** → AD7606 **RANGE**
- [ ] **GND** → AD7606 **GND**

## 四、软件配置

### 4.1 SPI配置

已在 `Core/Src/spi.c` 中配置：
- **Mode**: Master
- **Data Size**: 16 Bits
- **CPOL**: High
- **CPHA**: 2 Edge（SPI Mode 3）
- **Prescaler**: 8（SPI时钟 ≈ 15 MHz）

### 4.2 串口配置

已在 `Core/Src/usart.c` 中配置：
- **BaudRate**: 115200
- **Word Length**: 8 bits
- **Stop Bits**: 1
- **Parity**: None

## 五、程序功能说明

### 5.1 初始化流程

1. 初始化系统时钟和外设
2. 初始化AD7606（复位、配置量程和过采样）
3. 启动第一次转换（填充流水线）
4. 通过串口输出初始化信息

### 5.2 主循环流程

1. **启动转换**：通过CONVST信号启动AD转换
2. **等待转换完成**：延时1ms（无过采样时转换时间约4μs）
3. **读取数据**：通过SPI读取8个通道的数据
4. **数据处理**：将V1通道的数据转换为电压值
5. **串口输出**：每100个样本打印一次结果

### 5.3 输出格式

```
Sample #100: V1=3276 (0x0CCC) = 1.0000 V
Sample #200: V1=0 (0x0000) = 0.0000 V
Sample #300: V1=-3276 (0xF334) = -1.0000 V
```

## 六、数据格式说明

### 6.1 AD7606输出格式

- **编码方式**：16位二进制补码
- **±5V量程**：
  - 满量程：+5V → 0x7FFF (32767)
  - 零电压：0V → 0x0000 (0)
  - 负满量程：-5V → 0x8000 (-32768)
  - 1 LSB = 10V / 65536 = 152.588 μV

### 6.2 电压转换公式

```c
// ±5V量程
voltage = (int16_t)adc_code * 10.0f / 32768.0f;

// ±10V量程
voltage = (int16_t)adc_code * 20.0f / 32768.0f;
```

## 七、测试步骤

### 7.1 硬件检查

1. 检查所有连接是否正确
2. 检查AD7606模块的跳线设置（SPI模式）
3. 检查电源连接（AVCC=5V, VDRIVE=3.3V或5V）
4. 检查信号源连接（V1通道）

### 7.2 软件测试

1. 编译并下载程序到STM32H743
2. 打开串口调试工具（115200波特率）
3. 观察串口输出：
   - 应该看到初始化信息
   - 每100个样本打印一次V1通道的数据
   - 对于1kHz、1V正弦波，应该看到电压值在-1V到+1V之间变化

### 7.3 预期结果

对于1kHz、1V幅值的正弦波输入：
- **峰值电压**：约±1V（对应ADC码值约±6553）
- **波形周期**：约1ms（1000个样本/秒）
- **数据变化**：应该看到正弦波形的采样值

## 八、常见问题

### Q1: 串口没有输出？

**检查：**
- 串口波特率是否为115200
- TX/RX引脚连接是否正确
- 串口工具配置是否正确

### Q2: 读取的数据都是0或固定值？

**检查：**
- SPI连接是否正确（SCK, MISO）
- CS信号是否正确控制
- CONVST信号是否正常
- AD7606是否正常复位

### Q3: 数据不正确？

**检查：**
- 量程设置是否正确（±5V vs ±10V）
- 信号源是否正常
- AD7606模块是否正常工作
- SPI时钟频率是否合适

### Q4: 采样频率不对？

**当前代码采样频率约1kHz**（HAL_Delay(1)）
- 如果需要更高频率，可以减少延时
- 如果需要精确频率，建议使用定时器中断

## 九、代码修改建议

### 9.1 如果需要修改GPIO引脚

修改 `Core/Inc/bsp/bsp_ad7606.h` 中的GPIO定义：

```c
/* 例如：将CONVST改为PB0 */
#define AD7606_CONVST_PORT      GPIOB
#define AD7606_CONVST_PIN       GPIO_PIN_0
```

### 9.2 如果需要修改采样频率

修改 `Core/Src/main.c` 中的延时：

```c
/* 当前：约1kHz */
HAL_Delay(1);

/* 改为10kHz： */
HAL_Delay(0);  /* 或使用定时器中断 */
```

### 9.3 如果需要打印所有通道

修改 `Core/Src/main.c` 中的打印代码：

```c
BSP_UART_Printf("V1=%d, V2=%d, V3=%d, V4=%d, V5=%d, V6=%d, V7=%d, V8=%d\r\n",
    (int16_t)ad7606_channels[0],
    (int16_t)ad7606_channels[1],
    (int16_t)ad7606_channels[2],
    (int16_t)ad7606_channels[3],
    (int16_t)ad7606_channels[4],
    (int16_t)ad7606_channels[5],
    (int16_t)ad7606_channels[6],
    (int16_t)ad7606_channels[7]);
```

## 十、下一步优化

1. **使用定时器中断**：实现精确的采样频率控制
2. **使用DMA**：提高SPI传输效率
3. **添加FIFO缓冲**：避免数据丢失
4. **添加BUSY信号检测**：更精确的转换完成检测

---

**祝测试顺利！如有问题，请检查硬件连接和GPIO定义。**

